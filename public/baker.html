<!doctype html>
<meta charset="utf-8" />
<title>Hourglass — Bake UI</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#0b0c10;--panel:#11131a;--muted:#9aa3ad;--text:#e8ecf1;--a:#4fc3f7;}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px system-ui,Segoe UI,Roboto}
  main{max-width:980px;margin:0 auto;padding:16px}
  h1{margin:0 0 12px 0;font-size:18px;color:#e0e6ee}
  fieldset{border:1px solid #222836;background:var(--panel);border-radius:14px;padding:12px;margin-bottom:14px}
  legend{padding:0 6px;color:var(--muted)}
  .row{display:grid;grid-template-columns:repeat(6, minmax(120px,1fr));gap:10px;margin-top:8px}
  label{display:flex;flex-direction:column;font-size:12px;color:var(--muted);gap:6px}
  input[type="number"],input[type="text"]{padding:8px;border-radius:10px;border:1px solid #222836;background:#0f121a;color:var(--text)}
  input[type="range"]{width:100%}
  .bar{height:10px;border-radius:999px;background:#171b24;border:1px solid #252a36;overflow:hidden}
  .fill{height:100%;background:linear-gradient(90deg,#4fc3f7,#22d3ee);width:0%}
  button{background:#141823;border:1px solid #2a2f3a;color:var(--text);border-radius:10px;padding:10px 14px;cursor:pointer}
  .grid{display:grid;grid-template-columns:1fr max-content;gap:12px;align-items:center}
  .logs{height:180px;overflow:auto;background:#0c0f16;border:1px solid #222836;border-radius:10px;padding:8px;font-family:ui-monospace,Consolas,monospace;font-size:12px}
  a{color:#86e1ff}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #1f2430;padding:8px;text-align:left;color:#cfd7e3}
  .muted{color:var(--muted)}
</style>
<main>
  <h1>⏳ Hourglass — Bake UI</h1>

  <fieldset>
    <legend>Parameters</legend>
    <div class="row">
      <label>Duration (sec)
        <input id="duration" type="number" min="10" max="1800" step="5" value="60">
      </label>
      <label>Grains
        <input id="grains" type="number" min="200" max="12000" step="100" value="3500">
      </label>
      <label>Top Fill (0–1)
        <input id="full" type="number" step="0.01" min="0.7" max="1" value="0.90">
      </label>
      <label>Neck (px)
        <input id="neck" type="number" min="8" max="30" step="1" value="12">
      </label>
      <label>Grain radius r
        <input id="r" type="number" step="0.1" min="1.0" max="5" value="2.6">
      </label>
      <label>Tilt (deg)
        <input id="tilt" type="number" step="0.1" min="0" max="3" value="1.2">
      </label>
    </div>
    <div class="row" style="margin-top:12px">
      <label>Curvature c1
        <input id="c1" type="number" step="0.01" min="1.0" max="2.0" value="1.10">
      </label>
      <label>Curvature c2
        <input id="c2" type="number" step="0.01" min="1.0" max="2.0" value="1.55">
      </label>
      <label>Capture FPS
        <input id="fps" type="number" min="15" max="60" step="1" value="30">
      </label>
      <label>Slat step (px)
        <input id="slat" type="number" min="2" max="12" step="1" value="4">
      </label>
      <div></div><div></div>
    </div>
    <div class="grid" style="margin-top:12px">
      <div>
        <button id="start">Start Bake</button>
        <span class="muted" id="status"></span>
      </div>
      <div>
        <a id="openPlayer" href="#" target="_blank" style="display:none">Open in Player ▸</a>
      </div>
    </div>
    <div class="bar" style="margin-top:10px"><div id="fill" class="fill"></div></div>
    <div class="logs" id="logs"></div>
  </fieldset>

  <fieldset>
    <legend>Existing Bakes</legend>
    <table id="list"><thead>
      <tr><th>Label</th><th>Open</th></tr>
    </thead><tbody></tbody></table>
  </fieldset>
</main>

<script>
const $ = id => document.getElementById(id);
const logs = $('logs'), fill = $('fill'), status = $('status'), openPlayer = $('openPlayer');

async function startBake(){
  logs.textContent = ''; fill.style.width = '0%'; status.textContent = '…starting';
  openPlayer.style.display = 'none'; openPlayer.href = '#';

  const body = {
    duration: +$('duration').value,
    grains: +$('grains').value,
    full: +$('full').value,
    neck: +$('neck').value,
    r: +$('r').value,
    tilt: +$('tilt').value,
    c1: +$('c1').value,
    c2: +$('c2').value,
    fps: +$('fps').value,
    slat: +$('slat').value
  };

  const res = await fetch('/api/bake', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  const { id } = await res.json();

  const ev = new EventSource(`/api/stream/${id}`);
  ev.addEventListener('log', e => { const {line}=JSON.parse(e.data); logs.textContent += line+'\n'; logs.scrollTop = logs.scrollHeight; });
  ev.addEventListener('progress', e => { const {pct,frame,target}=JSON.parse(e.data); fill.style.width = pct + '%'; status.textContent = `Frame ${frame}/${target}`; });
  ev.addEventListener('meta', e => { const d=JSON.parse(e.data); logs.textContent += JSON.stringify(d) + '\n'; logs.scrollTop = logs.scrollHeight; });
  ev.addEventListener('exit', e => { const {code}=JSON.parse(e.data); status.textContent += `  (exit ${code})`; });
  ev.addEventListener('done', e => {
    const { file } = JSON.parse(e.data);
    fill.style.width = '100%'; status.textContent = 'Done ✓';
    openPlayer.href = `/player.html?bake=${encodeURIComponent(file)}`;
    openPlayer.style.display = 'inline-block';
    refreshList();
    ev.close();
  });
}

async function refreshList(){
  try{
    const res = await fetch('/api/index', { cache:'no-store' });
    const list = await res.json();
    const tbody = $('list').querySelector('tbody');
    tbody.innerHTML = '';
    for (const it of list) {
      const tr = document.createElement('tr');
      const td1 = document.createElement('td'); td1.textContent = it.label; tr.appendChild(td1);
      const td2 = document.createElement('td');
      const a = document.createElement('a');
      a.href = `/player.html?bake=${encodeURIComponent(it.file)}`; a.target='_blank'; a.textContent='Open ▸';
      td2.appendChild(a); tr.appendChild(td2);
      tbody.appendChild(tr);
    }
  }catch{
    $('list').querySelector('tbody').innerHTML = '<tr><td colspan="2" class="muted">No index.json yet. Bake something!</td></tr>';
  }
}

$('start').onclick = startBake;
refreshList();
</script>
